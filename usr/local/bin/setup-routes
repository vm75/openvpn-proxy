#!/bin/sh

. $(dirname $0)/common.inc

function main() {
    loadSavedVars

    log "Configure routes for vpn-$1"

    if [ "$1" == "down" ] ; then
        # Remove all existing default routes
        ip route del default

        # Add default gateway
        ip route add default via ${DEFAULT_GATEWAY} dev eth0

        # Flush existing rules (to ensure clean slate)
        iptables -F

        # Allow related and established connections (for existing sessions to work)
        iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

        # Allow incoming connections only on port 8080
        iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
        iptables -A INPUT -p tcp -j DROP
    elif [ "$1" == "up" ] ; then
        # Remove all existing default routes
        ip route del default

        # Default route for all traffic through the VPN
        # ip route add default via 10.100.0.1 dev tun0

        # Flush existing rules to start fresh
        iptables -F

        # Allow incoming ESTABLISHED and RELATED connections on the VPN interface
        iptables -A INPUT -i tun0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

        # Drop all other incoming connections on the VPN interface
        iptables -A INPUT -i tun0 -j DROP
    fi
}

main "$@"

exit 0
