<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OpenVPN Proxy</title>
  <link rel="icon" href="data:;base64,=">
  <link rel="stylesheet" href="https://unpkg.com/bulma@latest/css/bulma.min.css">
  <script src="https://unpkg.com/vue@latest/dist/vue.global.js"></script>
  <script src="./utils/component-load.js"></script>
</head>

<body>
  <div class="box container mt-5">
    <h1 class="title">OpenVPN Proxy</h1>
    <div id="app">
    </div>
    <div id="modal"></div>
  </div>

  <script>
    Vue.createApp({
      data() {
        return {
          proxySettings: {
            serverName: '',
            serverEndpoint: '',
          },
          servers: [],
        }
      },
      components: {
        'modal': Vue.defineAsyncComponent(() => import('./modal.js')),
        'list-editor': Vue.defineAsyncComponent(() => import('./utils/list-editor.js')),
        'modal-array-item': Vue.defineAsyncComponent(() => import('./modal-value.js')),
        'basic': Vue.defineAsyncComponent(() => import('./basic-input.js')),
        'dynamic-form': Vue.defineAsyncComponent(() => import('./dynamic-form.js')),
      },
      template: `
        <div class="box">
          <h2 class="subtitle">OpenVPN Proxy Settings</h2>
          <section class="modal-card-body">
            <div class="field">
              <label class="label">OpenVPN Provider</label>
              <div class="control select is-fullwidth">
                <select v-model="proxySettings.serverName">
                  <option v-for="server in servers"
                    :key="server.name"
                    :value="server.name"
                    :selected="server.name === proxySettings.serverName">{{ server.name }}
                  </option>
                </select>
              </div>
            </div>
            <div class="field">
              <label class="label">Server Endpoint</label>
              <div class="control select is-fullwidth">
                <select v-model="proxySettings.serverEndpoint">
                  <option v-for="endpoint in endpoints"
                    :key="endpoint.name"
                    :value="endpoint.name"
                    :selected="endpoint.name === proxySettings.serverEndpoint">{{ endpoint.name }}
                  </option>
                </select>
              </div>
            </div>
          </section>
          <div class="mt-4 buttons">
            <button class="button is-success mx-auto" @click="saveProxySettings">Save</button>
          </div>
        </div>
        <div class="box">
          <h2 class="subtitle">OpenVPN Servers</h2>
          <div id="servers" class="box">
            <list-editor
              :name="'OpenVPN Servers'"
              :list="servers"
              :editItem="editServer"
              :addItem="editServer"
              :removeItem="deleteServer"
              :displayString="serversDisplayString"
              >
            </list-editor>
          </div>
        </div>`,
      methods: {
        async reload() {
          this.proxySettings = await fetch('/api/settings').then(response => response.json());
          this.servers = await fetch('/api/servers').then(response => response.json());
        },
        editServer: function (index) {
          injectComponent({
            elementId: "modal",
            name: 'edit-server',
            source: './config/edit-server.js',
            data: {
              server: index !== undefined ? this.servers[index] : {},
              showOnLoad: true
            },
            methods: {
              save: (data) => {
                fetch('/api/servers/save', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(data)
                }).then(() => {
                  this.reload();
                });
              }
            }
          });
        },
        deleteServer: function (index) {
          fetch(`/api/servers/delete/${this.servers[index].name}`, {
            method: 'DELETE'
          })
            .then(() => this.reload());
        },
        serversDisplayString: function (server) {
          return server.name;
        },
        saveProxySettings: function () {
          fetch(`/api/settings/save`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(this.proxySettings)
          });
        }
      },
      computed: {
        endpoints: function () {
          for (const server of this.servers) {
            if (server.name === this.proxySettings.serverName) {
              return server.endpoints;
            }
          }
          return [];
        }
      },
      mounted() {
        this.reload();
      }
    }).mount('#app')
  </script>
</body>

</html>